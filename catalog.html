<!DOCTYPE html>































<html lang="en">































<head>































    <meta charset="UTF-8">































    <meta name="viewport" content="width=device-width, initial-scale=1.0">































    <title>PSi Retail Services - Interactive Catalog</title>































    <style>































        :root {































            --psi-red: #F14C32;































            --psi-black: #231F20;































            --success: #28A745;































            --warning: #FFC107;































            --bg-light: #F8F9FA;































            --white: #FFFFFF;































            --border-light: #E6E8EB;































            --shadow-sm: 0 1px 3px rgba(35, 31, 32, 0.12);































            --shadow-md: 0 8px 18px rgba(35, 31, 32, 0.08);































            --shadow-strong: 0 16px 40px rgba(35, 31, 32, 0.12);































        }































































        * {































            box-sizing: border-box;































        }































































        body {































            margin: 0;































            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;































            background: var(--bg-light);































            color: var(--psi-black);































            line-height: 1.6;































        }































































        header {































            background: var(--white);































            border-bottom: 4px solid var(--psi-red);































            box-shadow: var(--shadow-sm);































        }































































        header .container {































            max-width: 1200px;































            margin: 0 auto;































            padding: 24px 24px 16px;































        }































































        header h1 {































            margin: 0;































            font-size: 28px;































            letter-spacing: 2px;































        }































































        header h1 span {































            color: var(--psi-red);































        }































































        header p {































            margin: 8px 0 0;































            color: var(--psi-red);































            font-weight: 600;































            text-transform: uppercase;































            letter-spacing: 1.5px;































            font-size: 13px;































        }































































        main.catalog-container {































            max-width: 1200px;































            margin: 32px auto;































            padding: 0 24px 48px;































            display: grid;































            grid-template-columns: minmax(0, 1fr) 320px;































            gap: 32px;































        }































































        .products-section {































            display: flex;































            flex-direction: column;































            gap: 16px;































        }































































        .filters-toolbar {































            display: flex;































            flex-wrap: wrap;































            gap: 16px;































            align-items: flex-end;































            background: var(--white);































            padding: 16px;































            border-radius: 12px;































            box-shadow: var(--shadow-sm);































        }































































        .filter-group {































            display: flex;































            flex-direction: column;































            gap: 6px;































            min-width: 180px;































        }































































        .filter-group label {































            font-size: 12px;































            font-weight: 700;































            text-transform: uppercase;































            letter-spacing: 0.5px;































            color: #6C757D;































        }































































        .filter-group select {































            border: 1px solid var(--border-light);































            border-radius: 10px;































            padding: 10px 12px;































            font-size: 14px;































            font-weight: 600;































            background: var(--bg-light);































            color: var(--psi-black);































            outline: none;































            cursor: pointer;































        }































































        .filter-group select:focus {































            border-color: var(--psi-red);































            box-shadow: 0 0 0 3px rgba(241, 76, 50, 0.15);































        }































































        .filters-actions {































            margin-left: auto;































            display: flex;































            flex-direction: column;































            gap: 8px;































            align-items: flex-end;































        }































































        .filters-actions button {































            border: none;































            background: var(--bg-light);































            color: var(--psi-black);































            font-weight: 600;































            border-radius: 999px;































            padding: 10px 18px;































            cursor: pointer;































            box-shadow: var(--shadow-sm);































            transition: transform 0.15s ease, box-shadow 0.15s ease;































        }































































        .filters-actions button:hover {































            transform: translateY(-1px);































            box-shadow: var(--shadow-md);































        }































































        .products-meta {































            font-size: 13px;































            color: #6C757D;































        }































        .products-grid {































            display: grid;































            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));































            gap: 18px;































        }































































        .product-card {































            background: var(--white);































            border-radius: 12px;































            box-shadow: var(--shadow-sm);































            display: flex;































            flex-direction: column;































            overflow: hidden;































            transition: transform 0.15s ease, box-shadow 0.2s ease;































        }































































        .product-card:hover {































            transform: translateY(-4px);































            box-shadow: var(--shadow-strong);































        }































































        .product-image {































            background: var(--bg-light);































            padding: 20px;































            display: flex;































            justify-content: center;































            align-items: center;































            height: 220px;































            position: relative;































            overflow: hidden;































        }































































        .product-image img {































            max-width: 100%;































            max-height: 100%;































            object-fit: contain;































            transition: opacity 0.3s ease;































        }































        .product-image.carousel .carousel-nav {































            position: absolute;































            top: 50%;































            transform: translateY(-50%);































            background: rgba(35, 31, 32, 0.65);































            color: var(--white);































            border: none;































            width: 32px;































            height: 32px;































            border-radius: 50%;































            display: flex;































            align-items: center;































            justify-content: center;































            cursor: pointer;































            opacity: 0;































            transition: opacity 0.2s ease;































        }































































        .product-image.carousel:hover .carousel-nav {































            opacity: 1;































        }































































        .product-image.carousel .carousel-nav:focus-visible {































            outline: none;































            box-shadow: 0 0 0 3px rgba(241, 76, 50, 0.35);































            opacity: 1;































        }































































        .product-image.carousel .carousel-nav.prev {































            left: 12px;































        }































































        .product-image.carousel .carousel-nav.next {































            right: 12px;































        }































































        .product-image.carousel .carousel-indicators {































            position: absolute;































            bottom: 12px;































            left: 50%;































            transform: translateX(-50%);































            display: flex;































            gap: 6px;































        }































































        .product-image.carousel .carousel-indicators span {































            width: 8px;































            height: 8px;































            border-radius: 50%;































            background: rgba(255, 255, 255, 0.35);































            transition: background 0.2s ease;































        }































































        .product-image.carousel .carousel-indicators span.active {































            background: var(--psi-red);































        }































































        @media (hover: none) {































            .product-image.carousel .carousel-nav {































                opacity: 1;































            }































        }































































        .product-body {































            padding: 20px;































            display: flex;































            flex-direction: column;































            gap: 12px;































            flex: 1;































        }































































        .category-tag {































            display: inline-block;































            background: rgba(241, 76, 50, 0.1);































            color: var(--psi-red);































            font-weight: 600;































            padding: 4px 10px;































            border-radius: 999px;































            font-size: 12px;































            letter-spacing: 0.5px;































        }































































        .publisher {































            font-size: 13px;































            color: #6C757D;































            text-transform: uppercase;































            letter-spacing: 0.5px;































            margin-top: -6px;































        }































































        .product-title {































            font-size: 18px;































            margin: 0;































            font-weight: 700;































        }































































        .price-row {































            display: flex;































            justify-content: space-between;































            align-items: baseline;































            gap: 12px;































        }































































        .price-row .your-cost {































            font-size: 20px;































            font-weight: 700;































            color: var(--psi-black);































        }































































        .price-row .msrp {































            font-size: 14px;































            color: #6C757D;































        }































































        .margin-badge {































            display: inline-flex;































            align-items: center;































            gap: 6px;































            background: rgba(40, 167, 69, 0.12);































            color: var(--success);































            padding: 6px 12px;































            border-radius: 999px;































            font-weight: 600;































            font-size: 13px;































            width: fit-content;































        }































































        .product-meta {































            display: flex;































            flex-wrap: wrap;































            gap: 10px 16px;































            font-size: 13px;































            color: #545B62;































        }































































        .product-meta .meta-item {































            display: inline-flex;































            align-items: center;































            gap: 6px;































            font-weight: 600;































        }































































        .product-description {































            margin-top: 8px;































            font-size: 13px;































            color: #4C4F52;































            max-height: 4.8em;































            overflow: hidden;































            line-height: 1.6;































            transition: max-height 0.3s ease;































        }































































        .product-description.expanded {































            max-height: 600px;































        }































































        .toggle-description {































            margin-top: 6px;































            background: transparent;































            border: none;































            color: var(--psi-red);































            font-weight: 700;































            font-size: 13px;































            cursor: pointer;































            align-self: flex-start;































            padding: 0;































        }































































        .toggle-description:hover, .toggle-description:focus-visible {































            text-decoration: underline;































            outline: none;































        }































































        .case-hint {































            font-size: 12px;































            color: var(--warning);































            background: rgba(255, 193, 7, 0.12);































            padding: 6px 10px;































            border-radius: 8px;































        }































































        .quantity-controls {































            display: grid;































            grid-template-columns: 36px 1fr 36px;































            align-items: center;































            border: 1px solid var(--border-light);































            border-radius: 10px;































            overflow: hidden;































        }































































        .quantity-controls button {































            border: none;































            background: var(--bg-light);































            font-size: 18px;































            height: 38px;































            cursor: pointer;































            transition: background 0.15s;































        }































































        .quantity-controls button:hover {































            background: rgba(241, 76, 50, 0.12);































        }































































        .quantity-controls input {































            border: none;































            text-align: center;































            font-size: 15px;































            font-weight: 600;































            height: 38px;































            outline: none;































        }































































        .add-button {































            background: var(--psi-red);































            color: var(--white);































            border: none;































            border-radius: 999px;































            padding: 10px 18px;































            font-weight: 700;































            cursor: pointer;































            transition: transform 0.15s ease, box-shadow 0.15s ease;































            box-shadow: var(--shadow-sm);































        }































































        .add-button:hover {































            transform: translateY(-1px);































            box-shadow: var(--shadow-md);































        }































        .cart-panel {































            background: var(--white);































            border-radius: 16px;































            box-shadow: var(--shadow-strong);































            position: sticky;































            top: 24px;































            padding: 24px;































            display: flex;































            flex-direction: column;































            gap: 18px;































            max-height: calc(100vh - 48px);































            overflow: auto;































        }































































        .profit-display {































            background: var(--psi-red);































            color: var(--white);































            border-radius: 14px;































            padding: 20px;































            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);































        }































































        .profit-display h3 {































            margin: 0 0 8px;































            letter-spacing: 1px;































            text-transform: uppercase;































            font-size: 14px;































        }































































        .profit-display .profit-amount {































            font-size: 28px;































            font-weight: 700;































            margin-bottom: 4px;































        }































































        .profit-display .profit-subtext {































            margin: 0;































            font-size: 14px;































            opacity: 0.9;































        }































































        .minimum-banner {































            border-radius: 12px;































            padding: 12px 16px;































            font-size: 14px;































            font-weight: 600;































            background: rgba(255, 193, 7, 0.18);































            color: var(--psi-black);































            border: 1px solid rgba(255, 193, 7, 0.4);































        }































































        .minimum-banner.success {































            background: rgba(40, 167, 69, 0.18);































            border-color: rgba(40, 167, 69, 0.5);































            color: var(--success);































        }































































        .cart-items {































            display: flex;































            flex-direction: column;































            gap: 14px;































        }































































        .cart-item {































            border: 1px solid var(--border-light);































            border-radius: 12px;































            padding: 12px;































            display: grid;































            grid-template-columns: minmax(0, 1fr);































            gap: 10px;































            background: rgba(248, 249, 250, 0.7);































        }































































        .cart-item-header {































            display: flex;































            justify-content: space-between;































            align-items: flex-start;































            gap: 12px;































        }































































        .cart-item-title {































            font-weight: 600;































            margin: 0;































        }































































        .cart-item-sku {































            font-size: 12px;































            color: #6C757D;































        }































































        .cart-item-actions {































            display: flex;































            gap: 8px;































            align-items: center;































        }































































        .cart-item button {































            border: none;































            border-radius: 8px;































            padding: 6px 10px;































            cursor: pointer;































            font-weight: 600;































            background: var(--bg-light);































            transition: background 0.2s;































        }































































        .cart-item button:hover {































            background: rgba(241, 76, 50, 0.12);































        }































































        .cart-line {































            display: flex;































            justify-content: space-between;































            font-size: 13px;































            color: #495057;































        }































































        .cart-summary {































            border-top: 1px dashed var(--border-light);































            padding-top: 12px;































            display: flex;































            flex-direction: column;































            gap: 6px;































            font-size: 14px;































        }































































        .cart-summary div {































            display: flex;































            justify-content: space-between;































            font-weight: 600;































        }































































        .cart-actions {































            display: flex;































            flex-direction: column;































            gap: 10px;































        }































































        .cart-actions button {































            border: none;































            border-radius: 999px;































            padding: 12px 20px;































            font-weight: 700;































            cursor: pointer;































            transition: transform 0.15s ease, box-shadow 0.15s ease;































        }































































        .cart-actions button.primary {































            background: var(--psi-red);































            color: var(--white);































            box-shadow: var(--shadow-sm);































        }































































        .cart-actions button.primary:disabled {































            cursor: not-allowed;































            opacity: 0.6;































            transform: none;































            box-shadow: none;































        }































































        .cart-actions button.secondary {































            background: var(--bg-light);































            color: var(--psi-black);































            border: 1px solid var(--border-light);































        }































































        .cart-actions button:hover:not(:disabled) {































            transform: translateY(-1px);































            box-shadow: var(--shadow-md);































        }































































        .empty-cart {































            text-align: center;































            color: #6C757D;































            font-size: 14px;































            padding: 24px 12px;































        }































































        .offline-indicator {































            display: none;































            align-items: center;































            gap: 8px;































            font-size: 13px;































            background: rgba(23, 162, 184, 0.15);































            border: 1px solid rgba(23, 162, 184, 0.3);































            color: #0D6674;































            border-radius: 10px;































            padding: 10px 12px;































        }































































        .offline-indicator.active {































            display: flex;































        }































































        .loading-state {































            position: fixed;































            inset: 0;































            background: rgba(248, 249, 250, 0.9);































            backdrop-filter: blur(2px);































            display: flex;































            flex-direction: column;































            justify-content: center;































            align-items: center;































            gap: 16px;































            z-index: 1000;































        }































































        .loading-state.hidden {































            display: none;































        }































































        .spinner {































            width: 36px;































            height: 36px;































            border-radius: 50%;































            border: 3px solid rgba(35, 31, 32, 0.1);































            border-top-color: var(--psi-red);































            animation: spin 0.7s linear infinite;































        }































































        @keyframes spin {































            to {































                transform: rotate(360deg);































            }































        }































































        .profit-notification {































            position: fixed;































            top: 24px;































            right: 24px;































            background: var(--success);































            color: var(--white);































            padding: 12px 20px;































            border-radius: 999px;































            font-weight: 600;































            box-shadow: var(--shadow-strong);































            opacity: 0;































            transform: translateY(-10px);































            pointer-events: none;































            transition: opacity 0.3s ease, transform 0.3s ease;































            z-index: 900;































        }































































        .profit-notification.show {































            opacity: 1;































            transform: translateY(0);































        }































































        @media (max-width: 1080px) {































            main.catalog-container {































                grid-template-columns: 1fr;































            }































































            .cart-panel {































                position: static;































                max-height: none;































            }































        }































































        @media (max-width: 720px) {































            header .container {































                padding: 20px 18px;































            }































































            main.catalog-container {































                padding: 0 18px 32px;































            }































































            .products-grid {































                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));































            }































































            .filters-toolbar {































                flex-direction: column;































                align-items: stretch;































            }































































            .filters-actions {































                width: 100%;































                align-items: stretch;































            }































































            .filters-actions button {































                width: 100%;































            }































































            .profit-notification {































                top: auto;































                bottom: 24px;































                right: 50%;































                transform: translate(50%, 20px);































            }































































            .profit-notification.show {































                transform: translate(50%, 0);































            }































        }































    </style>































    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>















    <script src="full_catalog_data.js"></script>
    <script src="product_catalog_min_data.js"></script>































</head>































<body>































    <div id="loadingState" class="loading-state hidden">































        <div class="spinner"></div>































        <p>Loading your catalog...</p>































    </div>































































    <header>































        <div class="container">































            <h1>PSi <span>RETAIL SERVICES</span></h1>































            <p>Inspiring Play. Powering Growth.</p>































        </div>































    </header>































































    <main class="catalog-container">































        <section class="products-section">































            <div id="offlineIndicator" class="offline-indicator">































                <strong>Offline mode:</strong>































                <span>Using your last synchronized catalog.</span>































            </div>































            <div class="filters-toolbar">































                <div class="filter-group">































                    <label for="filterPublisher">Publisher</label>































                    <select id="filterPublisher"></select>































                </div>































                <div class="filter-group">































                    <label for="filterCategory">Game Category</label>































                    <select id="filterCategory"></select>































                </div>































                <div class="filter-group">































                    <label for="filterPriceBand">Price Band</label>































                    <select id="filterPriceBand"></select>































                </div>































                <div class="filter-group">































                    <label for="sortProducts">Sort By</label>































                    <select id="sortProducts"></select>































                </div>































                <div class="filters-actions">































                    <span id="productsCount" class="products-meta"></span>































                    <button id="clearFiltersButton" type="button">Reset Filters</button>































                </div>































            </div>































            <div id="productsGrid" class="products-grid"></div>































        </section>































































        <aside class="cart-panel">































            <div class="profit-display">































                <h3>Profit Potential</h3>































                <div class="profit-amount" id="profitAmount">$0.00</div>































                <p class="profit-subtext" id="profitSubtext">Sell-through on your order will generate $0.00 in profit for your store.</p>































            </div>































































            <div id="minimumBanner" class="minimum-banner">Minimum order: $850.00</div>































































            <div id="cartItems" class="cart-items"></div>































































            <div class="cart-summary">































                <div><span>Items</span><span id="cartItemCount">0</span></div>































                <div><span>Subtotal</span><span id="cartSubtotal">$0.00</span></div>































                <div><span>Projected Profit</span><span id="cartProfit">$0.00</span></div>































            </div>































































            <div class="cart-actions">































                <button id="exportButton" class="primary" type="button">Export Order</button>































                <button id="clearCartButton" class="secondary" type="button">Clear Cart</button>































            </div>































        </aside>































    </main>































































    <div id="profitToast" class="profit-notification"></div>































    































































    <script>































        const STORAGE_KEYS = {































            catalog: 'psi_catalog',































            catalogTimestamp: 'psi_catalog_updated',































            cart: 'psi_cart'































        };































































        const FILTER_DEFAULTS = Object.freeze({































            publisher: 'all',































            category: 'all',































            priceBand: 'all',































            sort: 'recommended'































        });































































        const PRICE_BANDS = [































            { id: 'under-10', label: 'Under $10', min: 0, max: 10 },































            { id: '10-20', label: '$10 - $20', min: 10, max: 20 },































            { id: '20-40', label: '$20 - $40', min: 20, max: 40 },































            { id: '40-plus', label: '$40+', min: 40, max: Infinity }































        ];































































        const PRICE_BAND_FALLBACK = { id: 'other', label: 'Other', min: -Infinity, max: Infinity };































































        const PRICE_BAND_LOOKUP = PRICE_BANDS.reduce((acc, band, index) => {































            acc[band.id] = { ...band, order: index };































            return acc;































        }, { [PRICE_BAND_FALLBACK.id]: { ...PRICE_BAND_FALLBACK, order: PRICE_BANDS.length } });































































        const FALLBACK_CATALOG_SOURCES = ['full_catalog.json?v=20250923', 'product_catalog_min.json'];



        const SUPPLEMENTAL_CATALOG_SOURCES = ['product_catalog_min.json?v=20250122'];



        const IMAGE_PLACEHOLDER = 'psi.svg';



































































        const SORT_OPTIONS = [































            { value: 'recommended', label: 'Recommended' },































            { value: 'title_asc', label: 'Title A-Z' },































            { value: 'publisher', label: 'Publisher (A-Z)' },































            { value: 'category', label: 'Game Category' },































            { value: 'price_band', label: 'Price Band' },































            { value: 'price_asc', label: 'Price: Low to High' },































            { value: 'price_desc', label: 'Price: High to Low' },































            { value: 'margin_desc', label: 'Margin: High to Low' }































        ];































































        let currencyCode = 'USD';































        let stateCatalog = null;































        let cartInstance = null;































        let currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: currencyCode });































































        const filterState = { ...FILTER_DEFAULTS };































































        const filterElements = {































            publisher: null,































            category: null,































            priceBand: null,































            sort: null,































            clear: null,































            count: null































        };































































        let filtersBound = false;































        const carouselTimers = new Map();







        let supplementalCatalogCache = null;



        let supplementalCatalogPromise = null;































































































        function cacheFilterElements() {































            if (filterElements.publisher) return;































            filterElements.publisher = document.getElementById('filterPublisher');































            filterElements.category = document.getElementById('filterCategory');































            filterElements.priceBand = document.getElementById('filterPriceBand');































            filterElements.sort = document.getElementById('sortProducts');































            filterElements.clear = document.getElementById('clearFiltersButton');































            filterElements.count = document.getElementById('productsCount');































        }































































        function clearCarouselTimers() {































            carouselTimers.forEach(id => clearInterval(id));































            carouselTimers.clear();































        }































































        async function fetchSupplementalCatalog() {
            const loadEmbeddedSupplement = () => {
                if (!window.SUPPLEMENTAL_CATALOG || typeof window.SUPPLEMENTAL_CATALOG !== 'object') {
                    return null;
                }
                try {
                    const cloned = JSON.parse(JSON.stringify(window.SUPPLEMENTAL_CATALOG));
                    supplementalCatalogCache = cloned;
                    return cloned;
                } catch (error) {
                    console.warn('Unable to clone embedded supplemental catalog:', error);
                    supplementalCatalogCache = window.SUPPLEMENTAL_CATALOG;
                    return supplementalCatalogCache;
                }
            };

            if (window.location.protocol === 'file:') {
                const embedded = loadEmbeddedSupplement();
                if (embedded) {
                    return embedded;
                }
            }

            for (const source of SUPPLEMENTAL_CATALOG_SOURCES) {
                try {
                    const response = await fetch(source, { cache: 'no-store' });
                    if (!response.ok) {
                        console.warn(`Supplemental catalog request failed for ${source}: ${response.status} ${response.statusText}`);
                        continue;
                    }
                    const data = await response.json();
                    if (data && typeof data === 'object') {
                        supplementalCatalogCache = data;
                        return data;
                    }
                } catch (error) {
                    console.warn(`Unable to fetch supplemental catalog from ${source}:`, error);
                }
            }

            const embeddedFallback = loadEmbeddedSupplement();
            if (embeddedFallback) {
                return embeddedFallback;
            }

            return null;
        }



        async function getSupplementalCatalog() {

            if (supplementalCatalogCache) return supplementalCatalogCache;

            if (!supplementalCatalogPromise) {

                supplementalCatalogPromise = fetchSupplementalCatalog().catch(error => {

                    console.warn('Supplemental catalog unavailable:', error);

                    return null;

                });

            }

            supplementalCatalogCache = await supplementalCatalogPromise;

            return supplementalCatalogCache;

        }



                        function buildSupplementIndex(products) {

            const index = new Map();

            if (!Array.isArray(products)) return index;

            products.forEach((product, position) => {

                if (!product) return;

                const sku = normalizeKey(product.sku);

                const id = normalizeKey(product.id);

                const upc = normalizeKey(product.upc);

                if (sku) index.set(`SKU:${sku}`, product);

                if (id) index.set(`ID:${id}`, product);

                if (upc) index.set(`UPC:${upc}`, product);

                index.set(`INDEX:${position}`, product);

            });

            return index;

        }



                        function findSupplementFor(product, index, position) {

            if (!product || !index || index.size === 0) return null;

            const sku = normalizeKey(product.sku);

            const id = normalizeKey(product.id);

            const upc = normalizeKey(product.upc);

            if (sku) {

                const lookup = index.get(`SKU:${sku}`) || index.get(`ID:${sku}`);

                if (lookup) return lookup;

            }

            if (id) {

                const lookup = index.get(`SKU:${id}`) || index.get(`ID:${id}`);

                if (lookup) return lookup;

            }

            if (upc) {

                const lookup = index.get(`UPC:${upc}`);

                if (lookup) return lookup;

            }

            if (typeof position === 'number') {

                const lookup = index.get(`INDEX:${position}`);

                if (lookup) return lookup;

            }

            return null;

        }



        function mergeProductWithSupplement(product, supplement) {

            if (!supplement) return product;

            let updated = product;



            const ensureClone = () => {

                if (updated === product) {

                    updated = { ...product };

                }

                return updated;

            };



            if (!hasMeaningfulTitle(product) && hasMeaningfulTitle(supplement)) {

                ensureClone().title = supplement.title;

            }



            if (!hasMeaningfulDescription(product) && hasMeaningfulDescription(supplement)) {

                ensureClone().description = supplement.description;

            }



            if (!hasValidNumber(product.price)) {

                const value = coerceNumber(supplement.price);

                if (value != null) {

                    ensureClone().price = value;

                }

            }



            if (!hasValidNumber(product.msrp)) {

                const value = coerceNumber(supplement.msrp);

                if (value != null) {

                    ensureClone().msrp = value;

                }

            }



            if (!hasValidNumber(product.margin, { allowZero: true })) {

                const value = coerceNumber(supplement.margin);

                if (value != null) {

                    ensureClone().margin = value;

                }

            }



            if (!hasValidPlayers(product.players)) {

                const players = clonePlayers(supplement.players);

                if (players) {

                    ensureClone().players = players;

                }

            }



            if (!hasValidNumber(product.ageMin, { allowZero: true })) {

                const value = coerceNumber(supplement.ageMin);

                if (value != null) {

                    ensureClone().ageMin = value;

                }

            }



            if (!hasMeaningfulText(product.sku) && hasMeaningfulText(supplement.sku)) {

                ensureClone().sku = supplement.sku;

            }



            if (!hasMeaningfulText(product.id) && hasMeaningfulText(supplement.id)) {

                ensureClone().id = supplement.id;

            }

            const primaryImage = sanitizeImageUrl(product.primaryImage);

            const supplementalPrimary = sanitizeImageUrl(supplement.primaryImage);

            if (!primaryImage && supplementalPrimary) {

                ensureClone().primaryImage = supplementalPrimary;

            }

            if (!product.images || !Object.values(product.images).some(value => sanitizeImageUrl(value))) {

                const clone = ensureClone();

                if (supplement.images) {

                    clone.images = { ...supplement.images };

                }

            }

            return updated;

        }



        async function applySupplementalDetails(catalog) {

            if (!catalogNeedsSupplement(catalog)) return catalog;

            const supplemental = await getSupplementalCatalog();

            if (!supplemental || !Array.isArray(supplemental.products)) return catalog;

            const indexMap = buildSupplementIndex(supplemental.products);

            let changed = false;

            const products = catalog.products.map((product, position) => {

                const supplement = findSupplementFor(product, indexMap, position);

                if (!supplement) return product;

                const merged = mergeProductWithSupplement(product, supplement);

                if (merged !== product) {

                    changed = true;

                }

                return merged;

            });

            return changed ? { ...catalog, products } : catalog;

        }








        async function fetchFallbackCatalog() {



            if (window.location.protocol === 'file:' && window.FALLBACK_FULL_CATALOG && typeof window.FALLBACK_FULL_CATALOG === 'object') {



                try {



                    return JSON.parse(JSON.stringify(window.FALLBACK_FULL_CATALOG));



                } catch (error) {



                    console.warn('Unable to clone embedded fallback catalog:', error);



                    return window.FALLBACK_FULL_CATALOG;



                }



            }







            for (const source of FALLBACK_CATALOG_SOURCES) {



                try {



                    const response = await fetch(source, { cache: 'no-store' });



                    if (!response.ok) {



                        console.warn(`Fallback catalog request failed for ${source}: ${response.status} ${response.statusText}`);



                        continue;



                    }



                    const data = await response.json();



                    if (data && typeof data === 'object') {



                        return data;



                    }



                } catch (error) {



                    console.warn(`Unable to fetch fallback catalog from ${source}:`, error);



                }



            }







            if (window.FALLBACK_FULL_CATALOG && typeof window.FALLBACK_FULL_CATALOG === 'object') {



                try {



                    return JSON.parse(JSON.stringify(window.FALLBACK_FULL_CATALOG));



                } catch (error) {



                    console.warn('Unable to clone embedded fallback catalog:', error);



                    return window.FALLBACK_FULL_CATALOG;



                }



            }







            return null;



        }































































        function getPriceBandOrder(bandId) {































            return PRICE_BAND_LOOKUP[bandId]?.order ?? PRICE_BANDS.length + 1;































        }































































        function getPriceBandLabel(bandId) {































            return PRICE_BAND_LOOKUP[bandId]?.label ?? PRICE_BAND_FALLBACK.label;































        }































































        function computePriceBandId(price) {































            if (typeof price !== 'number' || Number.isNaN(price)) {































                return PRICE_BAND_FALLBACK.id;































            }































            const band = PRICE_BANDS.find(range => price >= range.min && price < range.max);































            return band ? band.id : PRICE_BAND_FALLBACK.id;































        }































































        function hasMeaningfulText(value) {

            return typeof value === 'string' && value.trim().length > 0;

        }



        function hasMeaningfulDescription(product) {

            return product && hasMeaningfulText(product.description);

        }



        function hasMeaningfulTitle(product) {

            return product && hasMeaningfulText(product.title);

        }



        function coerceNumber(value) {

            if (typeof value === 'number') {

                return Number.isFinite(value) ? value : null;

            }

            if (typeof value === 'string') {

                const parsed = Number(value);

                return Number.isFinite(parsed) ? parsed : null;

            }

            return null;

        }



        function hasValidNumber(value, { allowZero = false } = {}) {

            const num = coerceNumber(value);

            if (num == null) return false;

            if (allowZero) return num >= 0;

            return num > 0;

        }



        function hasValidPlayers(players) {

            if (!players || typeof players !== 'object') return false;

            const min = coerceNumber(players.min);

            const max = coerceNumber(players.max);

            const hasMin = min != null && min > 0;

            const hasMax = max != null && max > 0;

            return hasMin || hasMax;

        }



        function clonePlayers(players) {

            if (!players || typeof players !== 'object') return null;

            const clone = {};

            const min = coerceNumber(players.min);

            const max = coerceNumber(players.max);

            if (min != null) {

                clone.min = min;

            }

            if (max != null) {

                clone.max = max;

            }

            return Object.keys(clone).length ? clone : null;

        }



        function normalizeKey(value) {

            if (value == null) return '';

            return String(value).trim().toUpperCase();

        }



        function productNeedsSupplement(product) {

            if (!product) return false;

            if (!hasMeaningfulTitle(product)) return true;

            if (!hasMeaningfulDescription(product)) return true;

            if (!hasValidNumber(product.price)) return true;

            if (!hasValidNumber(product.msrp)) return true;

            if (!hasValidPlayers(product.players)) return true;

            if (!hasValidNumber(product.ageMin, { allowZero: true })) return true;

            return false;

        }



        function catalogNeedsSupplement(catalog) {

            return catalog && Array.isArray(catalog.products) && catalog.products.some(productNeedsSupplement);

        }



        function setCurrency(code) {































            currencyCode = code || 'USD';































            currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: currencyCode });































        }































































        function formatCurrency(value) {































            if (Number.isNaN(value)) return '$0.00';































            return currencyFormatter.format(value);































        }































        function loadFromLocalStorage() {































            const stored = localStorage.getItem(STORAGE_KEYS.catalog);































            if (!stored) return null;































            try {































                const catalog = JSON.parse(stored);































                const enriched = ensureCatalogEnriched(catalog);































                stateCatalog = enriched;































                if (enriched.company && enriched.company.currency) {































                    setCurrency(enriched.company.currency);































                }































                document.getElementById('offlineIndicator').classList.add('active');































                return enriched;































            } catch (error) {































                console.error('Failed to parse stored catalog:', error);































                return null;































            }































        }































































        function saveCatalogToLocalStorage(catalog) {































            try {































                const enriched = ensureCatalogEnriched(catalog);































                localStorage.setItem(STORAGE_KEYS.catalog, JSON.stringify(enriched));































                localStorage.setItem(STORAGE_KEYS.catalogTimestamp, new Date().toISOString());































                return enriched;































            } catch (error) {































                console.warn('Unable to cache catalog locally:', error);































                return catalog;































            }































        }































































        async function loadCatalog() {

            const hash = window.location.hash.substring(1);



            if (hash) {

                try {

                    const json = LZString.decompressFromEncodedURIComponent(hash);

                    if (json) {

                        const parsed = JSON.parse(json);

                        let enriched = ensureCatalogEnriched(parsed);

                        enriched = await applySupplementalDetails(enriched);

                        enriched = ensureCatalogEnriched(enriched);

                        saveCatalogToLocalStorage(enriched);

                        document.getElementById('offlineIndicator').classList.remove('active');

                        stateCatalog = enriched;

                        if (enriched.company && enriched.company.currency) {

                            setCurrency(enriched.company.currency);

                        }

                        return enriched;

                    }

                    console.warn('Hash decompression returned empty payload.');

                } catch (error) {

                    console.error('Decompression failed:', error);

                }

            }



            const fallbackCatalog = await fetchFallbackCatalog();

            if (fallbackCatalog) {

                let enriched = ensureCatalogEnriched(fallbackCatalog);

                enriched = await applySupplementalDetails(enriched);

                enriched = ensureCatalogEnriched(enriched);

                saveCatalogToLocalStorage(enriched);

                document.getElementById('offlineIndicator').classList.remove('active');

                stateCatalog = enriched;

                if (enriched.company && enriched.company.currency) {

                    setCurrency(enriched.company.currency);

                }

                return enriched;

            }



            const storedCatalog = loadFromLocalStorage();

            if (storedCatalog) {

                let supplemented = await applySupplementalDetails(storedCatalog);

                supplemented = ensureCatalogEnriched(supplemented);

                if (supplemented !== storedCatalog) {

                    saveCatalogToLocalStorage(supplemented);

                }

                stateCatalog = supplemented;

                if (supplemented.company && supplemented.company.currency) {

                    setCurrency(supplemented.company.currency);

                }

                return supplemented;

            }



            if (window.FALLBACK_FULL_CATALOG && typeof window.FALLBACK_FULL_CATALOG === 'object') {

                try {

                    let enriched = ensureCatalogEnriched(JSON.parse(JSON.stringify(window.FALLBACK_FULL_CATALOG)));

                    enriched = await applySupplementalDetails(enriched);

                    enriched = ensureCatalogEnriched(enriched);

                    saveCatalogToLocalStorage(enriched);

                    document.getElementById('offlineIndicator').classList.remove('active');

                    stateCatalog = enriched;

                    if (enriched.company && enriched.company.currency) {

                        setCurrency(enriched.company.currency);

                    }

                    return enriched;

                } catch (error) {

                    console.warn('Unable to clone embedded fallback catalog:', error);

                    return window.FALLBACK_FULL_CATALOG;

                }

            }



            return null;

        }

































































        function getStoredCart() {































            const stored = localStorage.getItem(STORAGE_KEYS.cart);































            if (!stored) return [];































            try {































                return JSON.parse(stored);































            } catch (error) {































                console.warn('Failed to parse stored cart:', error);































                return [];































            }































        }































































        function persistCart(items) {































            try {































                localStorage.setItem(STORAGE_KEYS.cart, JSON.stringify(items));































            } catch (error) {































                console.warn('Unable to persist cart:', error);































            }































        }































































        function calculateMarginPercent(product) {































            if (typeof product.margin === 'number') return product.margin;































            if (!product.msrp) return 0;































            const margin = ((product.msrp - product.price) / product.msrp) * 100;































            return Math.round(margin * 10) / 10;































        }































































        function ensureCatalogEnriched(catalog) {































            if (!catalog || !Array.isArray(catalog.products)) return catalog;































            const products = catalog.products.map((product, index) => {































                const priceBandId = product.priceBandId || computePriceBandId(product.price);































                const priceBandLabel = product.priceBandLabel || getPriceBandLabel(priceBandId);































                const margin = typeof product.margin === 'number' ? product.margin : calculateMarginPercent(product);































                const originalIndex = product.originalIndex ?? index;































                return {































                    ...product,































                    priceBandId,































                    priceBandLabel,































                    margin,































                    originalIndex































                };































            });































            return { ...catalog, products };































        }































        function sanitizeImageUrl(url) {































            if (!url) return null;































            try {































                const trimmed = url.trim();































                if (!trimmed) return null;



                const lower = trimmed.toLowerCase();

                if (lower === '0' || lower === 'null' || lower === 'undefined' || lower === '#') {

                    return null;

                }































                if (trimmed.startsWith('http://')) {































                    return 'https://' + trimmed.substring(7);































                }































                return trimmed;































            } catch (error) {































                return null;































            }































        }































































        function getProductImages(product) {































            const sources = [































                product.primaryImage,































                product.images && product.images.main,































                product.images && product.images.front,































                product.images && product.images.angle,































                product.images && product.images.pack































            ];































            const unique = [];































            const seen = new Set();































            sources.forEach(source => {































                const sanitized = sanitizeImageUrl(source);































                if (sanitized && !seen.has(sanitized)) {































                    seen.add(sanitized);































                    unique.push(sanitized);































                }































            });































            if (!unique.length) {































                unique.push('psi.svg');































            }































            return unique;































        }































































        function escapeHtml(value) {































            if (!value) return '';































            const entityMap = {































                '&': '&amp;',































                '<': '&lt;',































                '>': '&gt;',































                '"': '&quot;',































                "'": '&#39;'































            };































            return value.replace(/[&<>"']/g, char => entityMap[char] || char);































        }































































        function formatPlayerCount(players) {































            if (!players) return '';































            const min = players && (players.min ?? players.minimum ?? players.from);































            const max = players && (players.max ?? players.maximum ?? players.to);































            if (min && max) {































                if (min === max) {































                    return `${min} ${min === 1 ? 'player' : 'players'}`;































                }































                return `${min} - ${max} players`;































            }































            if (min) {































                return `${min}+ players`;































            }































            if (max) {































                return `${max} players`;































            }































            return '';































        }































































        function productPrimaryImage(product) {































            return getProductImages(product)[0];































        }































































        function normalizeQuantity(value, product) {































            const min = Math.max(product.minQty || 1, 1);































            let qty = parseInt(value, 10);































            if (Number.isNaN(qty)) qty = min;































            if (qty < min) qty = min;































            return qty;































        }































































        class Cart {































            constructor(minimumOrder = 850) {































                this.minimumOrder = minimumOrder;































                this.items = getStoredCart();































                this.catalogMap = new Map();































                this.onUpdate = null;































            }































































            setCatalogProducts(products = []) {































                this.catalogMap = new Map(products.map(p => [p.sku, p]));































                this.items = this.items.map(item => this.mergeCatalogData(item));































                this.emit();































            }































































            mergeCatalogData(item) {































                const catalogProduct = this.catalogMap.get(item.sku);































                if (!catalogProduct) return item;































                return {































                    sku: item.sku,































                    title: catalogProduct.title || item.title,































                    price: catalogProduct.price,































                    msrp: catalogProduct.msrp,































                    quantity: item.quantity,































                    caseQty: catalogProduct.caseQty || 1,































                    minQty: catalogProduct.minQty || 1,































                    publisher: catalogProduct.publisher || item.publisher,































                    margin: calculateMarginPercent(catalogProduct),































                    priceBandId: catalogProduct.priceBandId,































                    priceBandLabel: catalogProduct.priceBandLabel































                };































            }































































            addItem(product, quantity) {































                const normalizedQty = normalizeQuantity(quantity, product);































                const existing = this.items.find(item => item.sku === product.sku);































                if (existing) {































                    existing.quantity += normalizedQty;































                } else {































                    this.items.push({































                        sku: product.sku,































                        title: product.title,































                        price: product.price,































                        msrp: product.msrp,































                        quantity: normalizedQty,































                        caseQty: product.caseQty || 1,































                        minQty: product.minQty || 1,































                        publisher: product.publisher,































                        margin: calculateMarginPercent(product),































                        priceBandId: product.priceBandId,































                        priceBandLabel: product.priceBandLabel































                    });































                }































                this.showProfitAnimation('Item Added to Cart');































                this.emit();































            }































































            updateQuantity(sku, quantity) {































                const item = this.items.find(entry => entry.sku === sku);































                if (!item) return;































                const parsed = parseInt(quantity, 10);































                if (Number.isNaN(parsed) || parsed <= 0) {































                    this.removeItem(sku);































                    return;































                }































                const product = this.catalogMap.get(sku) || item;































                const normalizedQty = normalizeQuantity(parsed, product);































                item.quantity = normalizedQty;































                this.emit();































            }































































            removeItem(sku) {































                this.items = this.items.filter(item => item.sku !== sku);































                this.emit();































            }































































            clear() {































                this.items = [];































                this.emit();































            }































































            getTotals() {































                return this.items.reduce((totals, item) => {































                    const subtotal = item.price * item.quantity;































                    const profit = (item.msrp - item.price) * item.quantity;































                    totals.subtotal += subtotal;































                    totals.profit += profit;































                    totals.items += item.quantity;































                    return totals;































                }, { subtotal: 0, profit: 0, items: 0 });































            }































































            canCheckout() {































                return this.getTotals().subtotal >= this.minimumOrder;































            }































































            emit() {































                persistCart(this.items);































                if (typeof this.onUpdate === 'function') {































                    this.onUpdate(this);































                }































            }































































            showProfitAnimation(message) {































                const toast = document.getElementById('profitToast');































                toast.textContent = message;































                toast.classList.add('show');































                clearTimeout(this.animationTimeout);































                this.animationTimeout = setTimeout(() => {































                    toast.classList.remove('show');































                }, 1800);































            }































        }































        function renderProducts(products = []) {































            const grid = document.getElementById('productsGrid');































            grid.innerHTML = '';































            clearCarouselTimers();































































            if (!products.length) {































                const empty = document.createElement('div');































                empty.className = 'empty-cart';































                empty.textContent = 'No products found in this catalog.';































                grid.appendChild(empty);































                return;































            }































































            const fragment = document.createDocumentFragment();































































            products.forEach(product => {































                const priceBandLabel = product.priceBandLabel || getPriceBandLabel(product.priceBandId);































                const card = document.createElement('article');































                card.className = 'product-card';































                const productImages = getProductImages(product);































                const firstImage = productImages[0];































                const playerCount = formatPlayerCount(product.players);































                const descriptionText = (product.description || '').trim();































                const descriptionHtml = escapeHtml(descriptionText);































                const descriptionMarkup = descriptionHtml ? descriptionHtml.replace(new RegExp('\r?\n', 'g'), '<br>') : '';































                card.innerHTML = `































                    <div class="product-image carousel" data-sku="${product.sku}">































                        <img class="carousel-image" loading="lazy" decoding="async" referrerpolicy="no-referrer" src="${firstImage}" alt="${product.title}" data-index="0">































                        <button type="button" class="carousel-nav prev" data-carousel="prev" aria-label="Previous image">&lsaquo;</button>































                        <button type="button" class="carousel-nav next" data-carousel="next" aria-label="Next image">&rsaquo;</button>































                        <div class="carousel-indicators"></div>































                    </div>































                    <div class="product-body">































                        <span class="category-tag">${product.category || 'PSi Catalog'}</span>































                        <p class="publisher">${product.publisher || ''}</p>































                        <h2 class="product-title">${product.title}</h2>































                        <div class="price-row">































                            <span class="your-cost">${formatCurrency(product.price)}</span>































                            <span class="msrp">MSRP ${formatCurrency(product.msrp)}</span>































                        </div>































                        <div class="margin-badge">Margin ${calculateMarginPercent(product).toFixed(1)}%</div>































                        ${playerCount ? `<div class="product-meta"><span class="meta-item">${playerCount}</span></div>` : ''}































                        <div class="case-hint">Case qty: ${product.caseQty || 1} &bull; Min order: ${product.minQty || 1} &bull; Price band: ${priceBandLabel}</div>































                        ${descriptionMarkup ? `<p class="product-description">${descriptionMarkup}</p><button type="button" class="toggle-description" data-toggle="description">Show Details</button>` : ''}































                        <div class="quantity-controls" data-sku="${product.sku}">































                            <button type="button" aria-label="Decrease quantity" data-action="decrement">-</button>































                            <input type="number" min="${product.minQty || 1}" step="${product.caseQty || 1}" value="${product.caseQty || product.minQty || 1}">































                            <button type="button" aria-label="Increase quantity" data-action="increment">+</button>































                        </div>































                        <button class="add-button" type="button">Add to Order</button>































                    </div>































                `;































































                const qtyControls = card.querySelector('.quantity-controls');































                const input = qtyControls.querySelector('input');































                const decrement = qtyControls.querySelector('[data-action="decrement"]');































                const increment = qtyControls.querySelector('[data-action="increment"]');































                const step = Math.max(product.caseQty || 1, 1);































                const min = Math.max(product.minQty || 1, 1);































































                decrement.addEventListener('click', () => {































                    let current = parseInt(input.value, 10);































                    if (Number.isNaN(current)) current = min;































                    current = Math.max(min, current - step);































                    input.value = current;































                });































































                increment.addEventListener('click', () => {































                    let current = parseInt(input.value, 10);































                    if (Number.isNaN(current)) current = min;































                    current += step;































                    input.value = current;































                });































































                input.addEventListener('blur', () => {































                    input.value = normalizeQuantity(input.value, product);































                });































































                const addButton = card.querySelector('.add-button');































                addButton.addEventListener('click', () => {































                    const quantity = normalizeQuantity(input.value, product);































                    input.value = quantity;































                    cartInstance.addItem(product, quantity);































                });































































                setupProductCarousel(card, product.sku, productImages);































                setupDescriptionToggle(card);































                fragment.appendChild(card);































            });































































            grid.appendChild(fragment);































        }































































        function setupProductCarousel(card, sku, images) {































            const container = card.querySelector('.product-image.carousel');































            const imageEl = container?.querySelector('.carousel-image');































            if (!container || !imageEl) return;


            imageEl.loading = 'lazy';
            imageEl.decoding = 'async';
            imageEl.referrerPolicy = 'no-referrer';
            imageEl.dataset.failed = 'false';
            imageEl.addEventListener('error', () => {
                if (imageEl.dataset.failed === 'true') return;
                imageEl.dataset.failed = 'true';
                imageEl.src = IMAGE_PLACEHOLDER;
            });





























































            const prevButton = container.querySelector('[data-carousel="prev"]');































            const nextButton = container.querySelector('[data-carousel="next"]');































            const indicators = container.querySelector('.carousel-indicators');































































            if (indicators) {































                indicators.innerHTML = '';































                images.forEach((_, index) => {































                    const dot = document.createElement('span');































                    if (index === 0) {































                        dot.classList.add('active');































                    }































                    indicators.appendChild(dot);































                });































            }































































            if (images.length <= 1) {































                if (prevButton) prevButton.style.display = 'none';































                if (nextButton) nextButton.style.display = 'none';































                if (indicators) indicators.style.display = 'none';































                return;































            }































































            let currentIndex = 0;































































            const updateIndicators = () => {































                if (!indicators) return;































                indicators.querySelectorAll('span').forEach((dot, idx) => {































                    dot.classList.toggle('active', idx === currentIndex);































                });































            };































































            const updateDisplay = (nextIndex) => {































                if (!images.length) return;































                currentIndex = (nextIndex + images.length) % images.length;































                const target = images[currentIndex];
                if (!target) {
                    imageEl.dataset.failed = 'true';
                    imageEl.src = IMAGE_PLACEHOLDER;
                    imageEl.dataset.index = String(currentIndex);
                    updateIndicators();
                    return;
                }
                imageEl.dataset.failed = 'false';
                imageEl.src = target;































                imageEl.dataset.index = String(currentIndex);































                updateIndicators();































            };































































            const restartInterval = () => {































                if (carouselTimers.has(sku)) {































                    clearInterval(carouselTimers.get(sku));































                }































                const id = setInterval(() => {































                    updateDisplay(currentIndex + 1);































                }, 4000);































                carouselTimers.set(sku, id);































            };































































            prevButton?.addEventListener('click', () => {































                updateDisplay(currentIndex - 1);































                restartInterval();































            });































































            nextButton?.addEventListener('click', () => {































                updateDisplay(currentIndex + 1);































                restartInterval();































            });































































            container.addEventListener('mouseenter', () => {































                if (carouselTimers.has(sku)) {































                    clearInterval(carouselTimers.get(sku));































                }































            });































































            container.addEventListener('mouseleave', () => {































                restartInterval();































            });































            updateIndicators();































































            restartInterval();































        }































        function setupDescriptionToggle(card) {































            const descriptionEl = card.querySelector('.product-description');































            const toggleButton = card.querySelector('.toggle-description');































            if (!descriptionEl || !toggleButton) return;































































            if (!descriptionEl.textContent.trim()) {































                toggleButton.remove();































                return;































            }































































            toggleButton.setAttribute('aria-expanded', 'false');































            descriptionEl.setAttribute('aria-hidden', 'true');































































            toggleButton.addEventListener('click', () => {































                const expanded = descriptionEl.classList.toggle('expanded');































                toggleButton.textContent = expanded ? 'Show Less' : 'Show Details';































                toggleButton.setAttribute('aria-expanded', expanded ? 'true' : 'false');































                descriptionEl.setAttribute('aria-hidden', expanded ? 'false' : 'true');































            });































        }































        function compareStrings(a, b) {































            return (a || '').toString().localeCompare((b || '').toString(), undefined, { sensitivity: 'base', numeric: true });































        }































































        function sortProducts(products, sortKey) {































            const list = [...products];































            switch (sortKey) {































                case 'publisher':































                    return list.sort((a, b) => compareStrings(a.publisher, b.publisher) || compareStrings(a.title, b.title));































                case 'category':































                    return list.sort((a, b) => compareStrings(a.category, b.category) || compareStrings(a.title, b.title));































                case 'price_band':































                    return list.sort((a, b) => getPriceBandOrder(a.priceBandId) - getPriceBandOrder(b.priceBandId) || a.price - b.price);































                case 'price_asc':































                    return list.sort((a, b) => (a.price - b.price) || compareStrings(a.title, b.title));































                case 'price_desc':































                    return list.sort((a, b) => (b.price - a.price) || compareStrings(a.title, b.title));































                case 'margin_desc':































                    return list.sort((a, b) => (b.margin - a.margin) || compareStrings(a.title, b.title));































                case 'title_asc':































                    return list.sort((a, b) => compareStrings(a.title, b.title));































                case 'recommended':































                default:































                    return list.sort((a, b) => (a.originalIndex ?? 0) - (b.originalIndex ?? 0));































            }































        }































































        function applyFiltersAndSort(products = []) {































            const filtered = products.filter(product => {































                if (filterState.publisher !== 'all' && product.publisher !== filterState.publisher) return false;































                if (filterState.category !== 'all' && product.category !== filterState.category) return false;































                if (filterState.priceBand !== 'all' && product.priceBandId !== filterState.priceBand) return false;































                return true;































            });































            return sortProducts(filtered, filterState.sort);































        }































































        function updateProductDisplay() {































            if (!stateCatalog || !Array.isArray(stateCatalog.products)) {































                renderProducts([]);































                updateProductCount(0, 0);































                return;































            }































            cacheFilterElements();































            const visibleProducts = applyFiltersAndSort(stateCatalog.products);































            renderProducts(visibleProducts);































            updateProductCount(visibleProducts.length, stateCatalog.products.length);































        }































































        function updateProductCount(visible, total) {































            cacheFilterElements();































            if (!filterElements.count) return;































            if (!total) {































                filterElements.count.textContent = visible ? `Showing ${visible} products` : 'No products available';































                return;































            }































            filterElements.count.textContent = `Showing ${visible} of ${total} products`;































        }































































        function populateSelect(select, options, stateKey) {































            if (!select) return;































            const availableValues = options.map(option => option.value);































            if (!availableValues.includes(filterState[stateKey])) {































                filterState[stateKey] = FILTER_DEFAULTS[stateKey];































            }































            select.innerHTML = '';































            options.forEach(option => {































                const opt = document.createElement('option');































                opt.value = option.value;































                opt.textContent = option.label;































                if (option.value === filterState[stateKey]) {































                    opt.selected = true;































                }































                select.appendChild(opt);































            });































        }































































        function syncFilterControls() {































            cacheFilterElements();































            if (!filterElements.publisher) return;































            filterElements.publisher.value = filterState.publisher;































            filterElements.category.value = filterState.category;































            filterElements.priceBand.value = filterState.priceBand;































            filterElements.sort.value = filterState.sort;































        }































































        function setupFilterControls(catalog) {































            cacheFilterElements();































            if (!filterElements.publisher || !catalog || !Array.isArray(catalog.products)) return;































































            const products = catalog.products;































            const publishers = Array.from(new Set(products.map(product => product.publisher).filter(Boolean))).sort(compareStrings);































            const categories = (catalog.categories && catalog.categories.length)































                ? [...catalog.categories].sort(compareStrings)































                : Array.from(new Set(products.map(product => product.category).filter(Boolean))).sort(compareStrings);































































            const priceBandCounts = products.reduce((acc, product) => {































                const bandId = product.priceBandId || computePriceBandId(product.price);































                acc[bandId] = (acc[bandId] || 0) + 1;































                return acc;































            }, {});































































            const priceBandOptions = [































                { value: 'all', label: 'All Price Bands' },































                ...PRICE_BANDS.filter(band => priceBandCounts[band.id])































                    .map(band => ({ value: band.id, label: band.label })),































                ...(priceBandCounts[PRICE_BAND_FALLBACK.id]































                    ? [{ value: PRICE_BAND_FALLBACK.id, label: PRICE_BAND_FALLBACK.label }]































                    : [])































            ];































































            const publisherOptions = [































                { value: 'all', label: 'All Publishers' },































                ...publishers.map(publisher => ({ value: publisher, label: publisher }))































            ];































































            const categoryOptions = [































                { value: 'all', label: 'All Categories' },































                ...categories.map(category => ({ value: category, label: category }))































            ];































































            populateSelect(filterElements.publisher, publisherOptions, 'publisher');































            populateSelect(filterElements.category, categoryOptions, 'category');































            populateSelect(filterElements.priceBand, priceBandOptions, 'priceBand');































            populateSelect(filterElements.sort, SORT_OPTIONS, 'sort');































            syncFilterControls();































































            if (!filtersBound) {































                filterElements.publisher.addEventListener('change', event => {































                    filterState.publisher = event.target.value;































                    updateProductDisplay();































                });































                filterElements.category.addEventListener('change', event => {































                    filterState.category = event.target.value;































                    updateProductDisplay();































                });































                filterElements.priceBand.addEventListener('change', event => {































                    filterState.priceBand = event.target.value;































                    updateProductDisplay();































                });































                filterElements.sort.addEventListener('change', event => {































                    filterState.sort = event.target.value;































                    updateProductDisplay();































                });































                if (filterElements.clear) {































                    filterElements.clear.addEventListener('click', () => {































                        Object.assign(filterState, FILTER_DEFAULTS);































                        syncFilterControls();































                        updateProductDisplay();































                    });































                }































                filtersBound = true;































            }































        }































        function renderCart(cart) {































            const itemsContainer = document.getElementById('cartItems');































            itemsContainer.innerHTML = '';































































            if (!cart.items.length) {































                const empty = document.createElement('div');































                empty.className = 'empty-cart';































                empty.textContent = 'Your cart is empty. Start building your order.';































                itemsContainer.appendChild(empty);































            } else {































                const fragment = document.createDocumentFragment();































































                cart.items.forEach(item => {































                    const cartItem = document.createElement('div');































                    cartItem.className = 'cart-item';































                    cartItem.innerHTML = `































                        <div class="cart-item-header">































                            <div>































                                <p class="cart-item-title">${item.title}</p>































                                <span class="cart-item-sku">SKU: ${item.sku}</span>































                            </div>































                            <div class="cart-item-actions">































                                <button type="button" data-role="remove" data-sku="${item.sku}">Remove</button>































                            </div>































                        </div>































                        <div class="cart-line">































                            <span>Your Cost</span>































                            <span>${formatCurrency(item.price)}</span>































                        </div>































                        <div class="cart-line">































                            <span>MSRP</span>































                            <span>${formatCurrency(item.msrp)}</span>































                        </div>































                        <div class="cart-line">































                            <span>Margin</span>































                            <span>${item.margin != null ? item.margin.toFixed(1) : calculateMarginPercent(item).toFixed(1)}%</span>































                        </div>































                        <div class="cart-line">































                            <span>Quantity</span>































                            <span>































                                <input type="number" class="cart-qty-input" min="${item.minQty || 1}" step="${item.caseQty || 1}" value="${item.quantity}" data-sku="${item.sku}">































                            </span>































                        </div>































                        <div class="cart-line">































                            <span>Line Total</span>































                            <span>${formatCurrency(item.price * item.quantity)}</span>































                        </div>































                        <div class="cart-line">































                            <span>Line Profit</span>































                            <span>${formatCurrency((item.msrp - item.price) * item.quantity)}</span>































                        </div>































                    `;































































                    fragment.appendChild(cartItem);































                });































































                itemsContainer.appendChild(fragment);































































                itemsContainer.querySelectorAll('[data-role="remove"]').forEach(btn => {































                    btn.addEventListener('click', () => {































                        cart.removeItem(btn.dataset.sku);































                    });































                });































































                itemsContainer.querySelectorAll('.cart-qty-input').forEach(input => {































                    input.addEventListener('change', () => {































                        cart.updateQuantity(input.dataset.sku, input.value);































                    });































                    input.addEventListener('blur', () => {































                        cart.updateQuantity(input.dataset.sku, input.value);































                    });































                });































            }































































            const totals = cart.getTotals();































            document.getElementById('cartItemCount').textContent = totals.items;































            document.getElementById('cartSubtotal').textContent = formatCurrency(totals.subtotal);































            document.getElementById('cartProfit').textContent = formatCurrency(totals.profit);































































            document.getElementById('profitAmount').textContent = formatCurrency(totals.profit);































            document.getElementById('profitSubtext').textContent = totals.items































                ? `Sell-through on your order will generate ${formatCurrency(totals.profit)} in profit for your store.`































                : "Sell-through on your order will generate $0.00 in profit for your store.";































































            const minimumBanner = document.getElementById('minimumBanner');































            const difference = Math.max(cart.minimumOrder - totals.subtotal, 0);































            if (difference > 0) {































                minimumBanner.textContent = `Add ${formatCurrency(difference)} more to reach the $${cart.minimumOrder.toFixed(2)} minimum order.`;































                minimumBanner.classList.remove('success');































            } else {































                minimumBanner.textContent = `Great! You've met the $${cart.minimumOrder.toFixed(2)} minimum order.`;































                minimumBanner.classList.add('success');































            }































































            const exportButton = document.getElementById('exportButton');































            exportButton.disabled = !cart.canCheckout();































        }































































        function exportOrder() {































            if (!cartInstance) return;































            const totals = cartInstance.getTotals();































































            if (totals.subtotal < cartInstance.minimumOrder) {































                const difference = cartInstance.minimumOrder - totals.subtotal;































                alert(`Minimum order is ${formatCurrency(cartInstance.minimumOrder)}. Add ${formatCurrency(difference)} more to export.`);































                return;































            }































































            const rows = [































                ['SKU', 'Product', 'Qty', 'Unit Price', 'Line Total', 'Profit']































            ];































































            cartInstance.items.forEach(item => {































                rows.push([































                    item.sku,































                    `"${item.title}"`,































                    item.quantity,































                    item.price.toFixed(2),































                    (item.price * item.quantity).toFixed(2),































                    ((item.msrp - item.price) * item.quantity).toFixed(2)































                ]);































            });































































            rows.push([]);































            rows.push(['', 'Subtotal', totals.items, totals.subtotal.toFixed(2), '', '']);































            rows.push(['', 'Projected Profit', '', '', '', totals.profit.toFixed(2)]);































































            const csvContent = rows.map(row => row.join(",")).join(String.fromCharCode(13, 10));































            const blob = new Blob([csvContent], { type: 'text/csv' });































            const downloadUrl = URL.createObjectURL(blob);































            const link = document.createElement('a');































            link.href = downloadUrl;































            link.download = `psi_order_${Date.now()}.csv`;































            document.body.appendChild(link);































            link.click();































            document.body.removeChild(link);































            URL.revokeObjectURL(downloadUrl);































        }































































        function clearCart() {































            if (!cartInstance) return;































            const confirmed = confirm('Clear your current order?');































            if (confirmed) {































                cartInstance.clear();































            }































        }































































        function showLoadingState(visible) {































            const loading = document.getElementById('loadingState');































            if (!loading) return;































            loading.classList.toggle('hidden', !visible);































        }































































        async function initializeCatalog() {































            showLoadingState(true);































            Object.assign(filterState, FILTER_DEFAULTS);































            const catalog = await loadCatalog();































































            if (!catalog) {































                showLoadingState(false);































                alert('Catalog unavailable. Please connect to the internet and try your link again.');































                return;































            }































































            const minimumOrder = (catalog.company && catalog.company.minimumOrder) || 850;































            cartInstance = new Cart(minimumOrder);































            cartInstance.onUpdate = renderCart;































            cartInstance.setCatalogProducts(catalog.products);































            setupFilterControls(catalog);































            updateProductDisplay();































            renderCart(cartInstance);































































            document.getElementById('exportButton').addEventListener('click', exportOrder);































            document.getElementById('clearCartButton').addEventListener('click', clearCart);































































            showLoadingState(false);































        }































































        window.addEventListener('hashchange', async () => {































            const catalog = await loadCatalog();































            if (catalog && cartInstance) {































                cartInstance.setCatalogProducts(catalog.products);































                cartInstance.minimumOrder = (catalog.company && catalog.company.minimumOrder) || 850;































                Object.assign(filterState, FILTER_DEFAULTS);































                setupFilterControls(catalog);































                updateProductDisplay();































                renderCart(cartInstance);































            }































        });































































        window.addEventListener('DOMContentLoaded', () => {































            initializeCatalog();































        });































































        window.addEventListener('online', () => {































            document.getElementById('offlineIndicator').classList.remove('active');































        });































































        window.addEventListener('offline', () => {































            document.getElementById('offlineIndicator').classList.add('active');































        });































    </script>































































</body>































</html>































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































